<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Player Profile</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="Styling/profilePlayer.css">

  <script>
    $(document).ready(function () {
      // ================= Fetch Profile =================
      $("#btn-fetch-profile").click(function () {
        let email = $("#txtmail").val().trim();
        if (!email) {
          alert("Enter an email to search");
          return;
        }
        $.ajax({
          type: "get",
          url: "/fetch-profile",
          data: { txtmail: email }
        })
          .done(function (responseAry) {
            if (responseAry.length === 0) {
              alert("No Data Available");
              return;
            }
            let p = responseAry[0];

            $("#txtname").val(p.name || "");
            $("#txtorg").val(p.organization || "");
            $("#txtnumber").val(p.number || "");
            $("#txtaddress").val(p.address || "");
            $("#txtcity").val(p.city || "");
            $("#selproof").val(p.proof || "");
            $("#txt-tour").val(p.prev_tour || "");

            // ID Proof
            if (responseAry[0].id == "ac") $("#ac").prop("selected", true); 
            else if (responseAry[0].id == "vc") $("#vc").prop("selected", true);
            else $("#pc").prop("selected", true);

            // Sports (multi-select)
            if (p.sports) {
              $("#selgames").val(p.sports.split(","));
            }

            // File
            if (p.picpath) {
              $("#file-url").val(p.picpath);
              if ($("#profile-pic-preview").length === 0) {
                $("#inputZip").after(`<img id="profile-pic-preview" src="${p.picpath}" class="mt-2 rounded" width="100">`);
              } else {
                $("#profile-pic-preview").attr("src", p.picpath);
              }
            }
          })
          .fail(function (err) {
            alert("Error: " + err.responseText);
          });
      });

      // ================= File Upload =================
      $("#inputZip").on("change", function () {
        let fileData = this.files[0];
        if (!fileData) return;

        let formData = new FormData();
        formData.append("proofpic", fileData);

        $.ajax({
          url: "/upload-proof",
          type: "post",
          data: formData,
          processData: false,
          contentType: false
        })
          .done(function (resp) {
            // Set uploaded URL
            $("#file-url").val(resp.url);
            // Preview image
            if ($("#profile-pic-preview").length === 0) {
              $("#inputZip").after(`<img id="profile-pic-preview" src="${resp.url}" class="mt-2 rounded" width="100">`);
            } else {
              $("#profile-pic-preview").attr("src", resp.url);
            }
            alert("File uploaded successfully!");
          })
          .fail(function (err) {
            alert("Upload failed: " + err.responseText);
          });
      });

      // ================= Save & Update =================
      function saveOrUpdate(actionUrl) {
        let formData = {
          txtmail: $("#txtmail").val().trim(),
          name: $("#txtname").val().trim(),
          organization: $("#txtorg").val().trim(),
          number: $("#txtnumber").val().trim(),
          address: $("#txtaddress").val().trim(),
          city: $("#txtcity").val().trim(),
          proof: $("#selproof").val(),
          picpath: $("#file-url").val().trim(),
          sports: $("#selgames").val() ? $("#selgames").val().join(",") : "",
          prev_tour: $("#txt-tour").val().trim()
        };

        // Validation
        if (!formData.txtmail || !formData.name) {
          alert("Email and Name are required.");
          return;
        }

        $.ajax({
          type: "post",
          url: actionUrl,
          data: formData
        })
          .done(function (resp) {
            alert(resp); // Pop-up alert
          })
          .fail(function (err) {
            alert("Error: " + err.responseText);
          });
      }

      $("#btn-save").click(function (e) {
        e.preventDefault();
        saveOrUpdate("/save-profile");
      });

      $("#btn-update").click(function (e) {
        e.preventDefault();
        saveOrUpdate("/update-profile");
      });
    });
  </script>
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
      <a class="navbar-brand fw-bold d-flex align-items-center" href="#">
        <img src="dashboardpics/Ansg.jpg" alt="Logo" width="40" height="40" class="rounded-circle me-2">
        AnshSports
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html"> Home</a></li>
          <li class="nav-item"><a class="nav-link active" href="DashPlayer.html">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link active" href="#"> My Profile</a></li>
          <li class="nav-item"><a class="nav-link" href="tournament-finder.html"> Find Tournaments</a></li>
          
          
          <li class="nav-item">
            <button class="btn btn-light text-dark ms-2" onclick="location.href='logout.html'">Logout</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- MAIN PROFILE CONTENT -->
  <div class="container mt-5 pt-5">
    <div class="card shadow p-4">
      <h2 class="text-center mb-3">Player Profile</h2>
      <p class="text-center info-text">
        Welcome to your profile page! Here you can manage your personal and sports details.
        Keep your profile updated so organizers and teams can know more about you.
      </p>
      <hr>

      <form class="row g-3">
        <!-- Email & Search -->
        <div class="col-md-5">
          <label for="txtmail" class="form-label">Email</label>
          <input type="email" class="form-control" id="txtmail" name="txtmail" >
        </div>
        <div class="col-md-1 d-flex align-items-end">
          <button type="button" class="btn btn-gradient w-100" id="btn-fetch-profile">Search</button>
        </div>

        <!-- Name -->
        <div class="col-md-6">
          <label for="txtname" class="form-label">Name</label>
          <input type="text" class="form-control" id="txtname" name="txtname" placeholder="Your Full Name">
        </div>

        <!-- Organization & Number -->
        <div class="col-md-6">
          <label for="txtorg" class="form-label">Organization</label>
          <input type="text" class="form-control" id="txtorg" name="txtorg">
        </div>
        <div class="col-md-6">
          <label for="txtnumber" class="form-label">Contact Number</label>
          <input type="tel" class="form-control" id="txtnumber" name="txtnumber" maxlength="10">
        </div>

        <!-- Address & City -->
        <div class="col-md-6">
          <label for="txtaddress" class="form-label">Address</label>
          <input type="text" class="form-control" id="txtaddress" name="txtaddress">
        </div>
        <div class="col-md-6">
          <label for="txtcity" class="form-label">City</label>
          <input type="text" class="form-control" id="txtcity" name="txtcity">
        </div>

        <!-- ID Proof & Upload -->
        <div class="col-md-6">
          <label class="form-label">ID Proof</label>
          <select class="form-select" id="selproof">
            <option value="" selected disabled>Choose Identity Proof</option>
            <option id="ac" value="Adhaar Card">Adhaar Card</option>
            <option id="vc" value="Voter Card">Voter Card</option>
            <option id="pc" value="Pan Card">Pan Card</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Upload File</label>
          <input type="file" class="form-control" id="inputZip" name="proofpic">
          <input type="text" class="form-control mt-2" id="file-url" placeholder="File URL will appear here" readonly>
        </div>

        <!-- Sports & Tournaments -->
        <div class="col-md-6">
          <label class="form-label">Deals in Sports</label>
          <select id="selgames" class="form-select" name="selgame" multiple>
            <option disabled>Choose Sports</option>
            <option>Cricket</option>
            <option>Hockey</option>
            <option>Badminton</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Previous Tournaments Hosted</label>
          <textarea class="form-control" name="txttour" id="txt-tour" rows="3"></textarea>
        </div>

        <!-- Checkbox -->
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="gridCheck">
            <label class="form-check-label" for="gridCheck">
              I confirm the above information is correct.
            </label>
          </div>
        </div>

        <!-- Buttons -->
        <div class="col-12 text-center">
          <button class="btn btn-gradient me-2 px-4" id="btn-save">Save</button>
          <button class="btn btn-gradient px-4" id="btn-update">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="text-white text-center py-3 mt-5">
    <p>© 2025 AnshSports | All Rights Reserved</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
